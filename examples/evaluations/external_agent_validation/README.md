# Validating and Evaluating External Agents

## Validation 

The `validate-external` command validates your external agent to the chat completions schema for streamed events.
The `validate-external` command stores validation results including the streamed events from the external agent for later triaging and debugging.

### Running Validation
1. Prepare an external agent following the [chat-completions spec](https://github.com/watson-developer-cloud/watsonx-orchestrate-developer-toolkit/tree/main/external_agent).
2. Create an external agent spec for your external agent. There is an example provided in `examples/evaluations/external_agent_validation/sample_external_agent_config.json` as a reference.
3. Prepare a TSV with two columns. The first column contains user stories. The second column is the expected summary or output. See `examples/evaluations/external_agent_validation/test.tsv`
4. The user stories are passed to the external agent to validate the events generated by the external agent adhere to the chat-completions schema.
```bash
orchestrate evaluations validate-external --tsv ./examples/evaluations/external_agent_validation/test.tsv --external-agent-config ./examples/evaluations/external_agent_validation/sample_external_agent_config.json` --credential "<API/BEARER TOKEN>"
```
5. The validation results are saved to a `validation_external` subfolder under the path provided for the `--output` flag.

ðŸš¨ Note: we expect `WATSONX_APIKEY, WATSONX_SPACE_ID` or `WO_INSTANCE, WO_API_KEY` be part of the environment variables or specified in .env_file. 

### Analyzing the Results
The `validation_results.json` emits the results from the validation tests. The validation tests send sample inputs and record the response. The "success" field indicates if the external agent events matched the [chat-completions spec](https://github.com/watson-developer-cloud/watsonx-orchestrate-developer-toolkit/tree/main/external_agent) 


The validation files contain the following fields:

1. success - boolean to indicate if the events streamed back adhered to the schema 
2. logged-events - streamed events from the external agent
3. messages - the messages that were sent to the external agent.

## Evaluating the External Agent
After validation, you can evaluate the external agent using the provided input.

### Running the Evaluation
1. Run the evaluation

```bash
orchestrate evaluations validate-external --tsv "./examples/evaluations/external_agent_validation/test.tsv" --external-agent-config "./examples/evaluations/external_agent_validation/sample_external_agent_config.json" --perf
```

The command will create a native agent with the name `external_agent_validation_{external_agent_name}_{random number}`. The native agent will have the external agent registered. Finally, the command will run the evaluation framework against provided user stories.
